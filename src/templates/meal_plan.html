{% extends "base.html" %}

{% block title %}Meal Planner - Weekly Plan{% endblock %}

{% block extra_css %}
<style>
.meal-plan-grid {
    display: grid;
    grid-template-columns: 120px repeat(7, 1fr);
    gap: 1px;
    background-color: #dee2e6;
    border: 1px solid #dee2e6;
}

.meal-plan-header {
    background-color: #f8f9fa;
    padding: 10px;
    text-align: center;
    font-weight: bold;
    border-bottom: 2px solid #007bff;
}

.meal-plan-day {
    background-color: #f8f9fa;
    padding: 10px;
    text-align: center;
    font-weight: bold;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.meal-plan-cell {
    background-color: white;
    padding: 8px;
    min-height: 80px;
    border: 1px solid #e9ecef;
    position: relative;
}

.meal-plan-cell:hover {
    background-color: #f8f9fa;
}

.meal-item {
    background-color: #e3f2fd;
    border: 1px solid #2196f3;
    border-radius: 4px;
    padding: 6px;
    margin-bottom: 4px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
}

.meal-item:hover {
    background-color: #bbdefb;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.meal-item img {
    width: 30px;
    height: 30px;
    object-fit: cover;
    border-radius: 3px;
    margin-right: 5px;
}

.meal-type-label {
    font-size: 0.75rem;
    color: #6c757d;
    font-weight: bold;
    margin-bottom: 4px;
}

.add-meal-btn {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    opacity: 0;
    transition: opacity 0.2s;
}

.meal-plan-cell:hover .add-meal-btn {
    opacity: 1;
}

.meal-plan-cell:empty .add-meal-btn {
    opacity: 0.3;
}

.meal-plan-controls {
    margin-bottom: 20px;
}

.week-navigation {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}

.week-display {
    font-size: 1.2rem;
    font-weight: bold;
    color: #495057;
}

.meal-search-modal .modal-body {
    max-height: 400px;
    overflow-y: auto;
}

.recipe-search-result {
    cursor: pointer;
    transition: background-color 0.2s;
}

.recipe-search-result:hover {
    background-color: #f8f9fa;
}

.meal-notes {
    font-size: 0.75rem;
    color: #6c757d;
    font-style: italic;
    margin-top: 2px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1><i class="fas fa-calendar-alt"></i> Weekly Meal Planner</h1>
                <div class="btn-group">
                    <button class="btn btn-outline-primary" onclick="clearMealPlan()">
                        <i class="fas fa-trash"></i> Clear Plan
                    </button>
                    <button class="btn btn-outline-success" onclick="printMealPlan()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Week Navigation -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="week-navigation">
                <a class="btn btn-outline-secondary" href="{{ url_for('meal_plan', week_start=prev_week) }}">
                    <i class="fas fa-chevron-left"></i> Previous Week
                </a>
                <div class="week-display">
                    Week of {{ week_start.strftime('%B %d, %Y') }}
                </div>
                <a class="btn btn-outline-secondary" href="{{ url_for('meal_plan', week_start=next_week) }}">
                    Next Week <i class="fas fa-chevron-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Meal Plan Table -->
    <table class="table table-bordered text-center align-middle">
        <thead>
            <tr>
                <th>Meal Type</th>
                {% for day in days %}
                <th>{{ day.day_short }}<br><small>{{ day.date.strftime('%m/%d') }}</small></th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for meal_type in meal_types %}
            <tr>
                <td class="fw-bold">{{ meal_type|capitalize }}</td>
                {% for day in days %}
                <td>
                    {% set meal = day.meals[meal_type] %}
                    {% if meal %}
                        <div class="meal-item mb-2">
                            <img src="{{ meal.recipe_image or '/static/images/placeholder.jpg' }}" alt="{{ meal.recipe_title }}" style="width:30px;height:30px;object-fit:cover;">
                            <span>{{ meal.recipe_title }}</span>
                            <br>
                            <small>{{ meal.servings }} serving{{ 's' if meal.servings > 1 else '' }}</small>
                            {% if meal.notes %}<div class="meal-notes">{{ meal.notes }}</div>{% endif %}
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="removeMeal({{ day.day_number }}, '{{ meal_type }}')">Remove</button>
                    {% else %}
                        <button class="btn btn-sm btn-success" onclick="addMeal({{ day.day_number }}, '{{ meal_type }}')">Add</button>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Add Meal Modal -->
    <div class="modal fade" id="mealModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Meal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="mealType">
                    <input type="hidden" id="mealDay">
                    <label for="recipeSearch" class="form-label">Search Recipe</label>
                    <input type="text" class="form-control mb-2" id="recipeSearch" placeholder="e.g. chicken curry">
                    <div id="searchResults"></div>
                    <label for="servings" class="form-label mt-2">Servings</label>
                    <input type="number" class="form-control mb-2" id="servings" value="1" min="1">
                    <label for="mealNotes" class="form-label">Notes (optional)</label>
                    <textarea class="form-control mb-2" id="mealNotes" rows="2"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// --- Meal Plan JS Logic ---
document.addEventListener('DOMContentLoaded', function() {
    let currentDay = null;
    let currentMealType = null;
    let selectedRecipe = null;
    let weekStart = "{{ week_start }}";

    function addMeal(day, mealType) {
        currentDay = day;
        currentMealType = mealType;
        selectedRecipe = null;
        document.getElementById('mealType').value = mealType;
        document.getElementById('mealDay').value = day;
        document.getElementById('recipeSearch').value = '';
        document.getElementById('searchResults').innerHTML = '';
        document.getElementById('servings').value = '1';
        document.getElementById('mealNotes').value = '';
        const modal = new bootstrap.Modal(document.getElementById('mealModal'));
        modal.show();
    }

    function removeMeal(day, mealType) {
        if (!confirm('Remove this meal from the plan?')) return;
        fetch('/meal-plan/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                week_start: weekStart,
                day_of_week: day,
                meal_type: mealType
            })
        })
        .then(response => response.json())
        .then(data => { location.reload(); })
        .catch(error => { alert('Error removing meal: ' + error); });
    }

    function displaySearchResults(recipes) {
        const resultsDiv = document.getElementById('searchResults');
        if (!recipes || recipes.length === 0) {
            resultsDiv.innerHTML = '<div class="alert alert-info">No recipes found. Try a different search term.</div>';
            return;
        }
        const recipesHtml = recipes.map(recipe => `
            <div class="recipe-search-result p-2 border-bottom" onclick="selectRecipe(${recipe.id}, '${escapeHtml(recipe.title)}', '${recipe.image ? recipe.image : ''}')">
                <img src="${recipe.image || '/static/images/placeholder.jpg'}" alt="${escapeHtml(recipe.title)}" style="width:40px;height:40px;object-fit:cover;margin-right:10px;">
                <span>${escapeHtml(recipe.title)}</span>
            </div>
        `).join('');
        resultsDiv.innerHTML = recipesHtml;
    }

    function selectRecipe(recipeId, recipeTitle, recipeImage) {
        selectedRecipe = { id: recipeId, title: recipeTitle, image: recipeImage };
        document.getElementById('searchResults').innerHTML = `<div class="alert alert-success">Selected: ${escapeHtml(recipeTitle)}</div>`;
        const modalFooter = document.querySelector('#mealModal .modal-footer');
        if (!document.getElementById('saveMealBtn')) {
            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn btn-primary';
            saveBtn.id = 'saveMealBtn';
            saveBtn.innerText = 'Save Meal';
            saveBtn.onclick = saveMeal;
            modalFooter.appendChild(saveBtn);
        }
    }

    function saveMeal() {
        if (!selectedRecipe) {
            alert('Please select a recipe.');
            return;
        }
        const servings = document.getElementById('servings').value;
        const notes = document.getElementById('mealNotes').value;
        fetch('/meal-plan/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                week_start: weekStart,
                day_of_week: currentDay,
                meal_type: currentMealType,
                recipe_id: selectedRecipe.id,
                recipe_title: selectedRecipe.title,
                recipe_image: selectedRecipe.image,
                servings: servings,
                notes: notes
            })
        })
        .then(response => response.json())
        .then(data => { location.reload(); })
        .catch(error => { alert('Error saving meal: ' + error); });
    }

    function escapeHtml(text) {
        return text.replace(/[&<>"']/g, function(c) {
            const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'};
            return map[c];
        });
    }

    // Attach search event every time modal is shown
    const mealModal = document.getElementById('mealModal');
    if (mealModal) {
        mealModal.addEventListener('shown.bs.modal', function () {
            const recipeSearchInput = document.getElementById('recipeSearch');
            if (recipeSearchInput) {
                recipeSearchInput.value = '';
                document.getElementById('searchResults').innerHTML = '';
                recipeSearchInput.oninput = function() {
                    const query = this.value.trim();
                    if (!query) {
                        document.getElementById('searchResults').innerHTML = '';
                        return;
                    }
                    document.getElementById('searchResults').innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
                    fetch('/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({ 'query': query, 'number': '6' })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            document.getElementById('searchResults').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                        } else {
                            displaySearchResults(data.recipes);
                        }
                    })
                    .catch(error => {
                        document.getElementById('searchResults').innerHTML = `<div class="alert alert-danger">Error searching recipes: ${error}</div>`;
                    });
                };
            }
        });
    }

    // Expose functions to global scope
    window.addMeal = addMeal;
    window.removeMeal = removeMeal;
    window.selectRecipe = selectRecipe;
});
</script>
{% endblock %} 