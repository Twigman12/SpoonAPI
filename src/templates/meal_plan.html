{% extends "base.html" %}

{% block title %}Weekly Meal Planner{% endblock %}

{% block extra_css %}
<style>
/* Meal Planner Specific Styles */
.meal-planner-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 2rem 0;
    color: #333;
    line-height: 1.6;
}

.meal-planner-content {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

/* Header Section */
.meal-planner-header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 20px;
}

.logo-section h1 {
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 10px;
}

.logo-section p {
    color: #666;
    font-size: 1.1rem;
}

.quick-actions {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 0.95rem;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    color: white;
}

.btn-secondary {
    background: rgba(255, 255, 255, 0.8);
    color: #333;
    border: 2px solid #e0e0e0;
}

.btn-secondary:hover {
    background: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    color: #333;
}

/* Week Navigation */
.week-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255, 255, 255, 0.6);
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 20px;
}

.week-display {
    text-align: center;
    font-size: 1.3rem;
    font-weight: 600;
    color: #333;
}

.week-display small {
    display: block;
    font-size: 0.9rem;
    color: #666;
    font-weight: 400;
}

.nav-btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
    text-decoration: none;
}

.nav-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    color: white;
}

/* Meal Grid */
.meal-grid-container {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
}

.meal-grid {
    display: grid;
    grid-template-columns: 140px repeat(7, 1fr);
    gap: 2px;
    background: #f8f9ff;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.grid-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 20px 15px;
    text-align: center;
    font-weight: 600;
    font-size: 0.95rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.day-header {
    background: linear-gradient(135deg, #4facfe, #00f2fe);
}

.meal-type-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    writing-mode: horizontal-tb;
}

.meal-slot {
    background: white;
    min-height: 140px;
    padding: 15px;
    position: relative;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.meal-slot:hover {
    background: #f8f9ff;
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
}

.meal-slot.empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #999;
    border: 2px dashed #ddd;
    border-radius: 10px;
    margin: 5px;
    min-height: 130px;
}

.meal-slot.empty:hover {
    border-color: #667eea;
    color: #667eea;
    background: rgba(102, 126, 234, 0.05);
}

.meal-slot.empty i {
    font-size: 2rem;
    margin-bottom: 8px;
    opacity: 0.6;
}

.meal-item {
    background: white;
    border-radius: 12px;
    padding: 12px;
    margin: 0;
    position: relative;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    border: 1px solid #f0f0f0;
    height: 100%;
}

.meal-actions {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.meal-item:hover .meal-actions {
    opacity: 1;
}

.action-btn {
    width: 28px;
    height: 28px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.edit-btn {
    background: #4CAF50;
    color: white;
}

.edit-btn:hover {
    background: #45a049;
    transform: scale(1.1);
}

.delete-btn {
    background: #f44336;
    color: white;
}

.delete-btn:hover {
    background: #da190b;
    transform: scale(1.1);
}

.meal-image {
    width: 100%;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 10px;
}

.meal-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 6px;
    line-height: 1.3;
}

.meal-meta {
    font-size: 0.8rem;
    color: #666;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}

.meal-notes {
    font-size: 0.75rem;
    color: #888;
    font-style: italic;
    margin-top: 6px;
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    display: none;
    z-index: 1000;
    animation: fadeIn 0.3s ease;
}

.modal-overlay.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal {
    background: white;
    border-radius: 20px;
    padding: 0;
    max-width: 800px;
    width: 90%;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.3s ease;
}

.modal-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 25px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.4rem;
}

.close-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 1.5rem;
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

.modal-body {
    padding: 30px;
    max-height: calc(90vh - 200px);
    overflow-y: auto;
}

.form-group {
    margin-bottom: 25px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
}

.form-control {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: white;
}

.form-control:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

/* Search Section */
.search-section {
    background: #f8f9ff;
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 20px;
}

.search-box {
    position: relative;
}

.search-input {
    padding-right: 50px;
}

.search-btn {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    background: #667eea;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
}

.recipe-results {
    max-height: 400px;
    overflow-y: auto;
    border: 2px solid #e0e0e0;
    border-radius: 15px;
    background: white;
    margin-top: 15px;
}

.recipe-item {
    display: flex;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: all 0.2s ease;
}

.recipe-item:hover {
    background: #f8f9ff;
}

.recipe-item:last-child {
    border-bottom: none;
}

.recipe-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 10px;
    margin-right: 15px;
}

.recipe-info {
    flex: 1;
}

.recipe-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
}

.recipe-meta {
    font-size: 0.9rem;
    color: #666;
}

.select-recipe-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.select-recipe-btn:hover {
    background: #218838;
    transform: translateY(-1px);
}

.selected-recipe {
    background: #f8f9ff;
    border: 2px solid #667eea;
    border-radius: 15px;
    padding: 20px;
    margin-top: 20px;
}

/* Toast Notifications */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 2000;
}

.toast {
    background: white;
    border-radius: 12px;
    padding: 15px 20px;
    margin-bottom: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    border-left: 4px solid #28a745;
    animation: slideInRight 0.3s ease;
    min-width: 300px;
}

.toast.error {
    border-left-color: #dc3545;
}

.toast.info {
    border-left-color: #17a2b8;
}

/* Loading States */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* Responsive Design */
@media (max-width: 1200px) {
    .meal-grid {
        grid-template-columns: 120px repeat(7, 1fr);
    }
}

@media (max-width: 768px) {
    .header-top {
        flex-direction: column;
        text-align: center;
    }

    .meal-grid {
        grid-template-columns: 100px repeat(3, 1fr);
    }

    .meal-grid .day-header:nth-child(n+6) {
        display: none;
    }

    .meal-slot:nth-child(8n+6),
    .meal-slot:nth-child(8n+7),
    .meal-slot:nth-child(8n+8) {
        display: none;
    }

    .form-row {
        grid-template-columns: 1fr;
    }

    .modal {
        width: 95%;
        margin: 20px;
    }
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { 
        opacity: 0;
        transform: translateY(-50px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideInRight {
    from { 
        opacity: 0;
        transform: translateX(100%);
    }
    to { 
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Accessibility */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* Focus styles */
button:focus,
.form-control:focus {
    outline: 2px solid #667eea;
    outline-offset: 2px;
}

/* Help tooltips */
.help-tooltip {
    position: relative;
    display: inline-block;
    margin-left: 5px;
    cursor: help;
}

.help-tooltip i {
    color: #999;
    font-size: 0.8rem;
}

.help-tooltip:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 0.8rem;
    white-space: nowrap;
    z-index: 1000;
}
</style>
{% endblock %}

{% block content %}
<div class="meal-planner-container">
    <div class="meal-planner-content">
        <!-- Header -->
        <div class="meal-planner-header">
            <div class="header-top">
                <div class="logo-section">
                    <h1><i class="fas fa-utensils"></i> Weekly Meal Planner</h1>
                    <p>Plan your weekly meals with ease and discover new recipes</p>
                </div>
                <div class="quick-actions">
                    <button class="btn btn-primary" onclick="openAddMealModal()">
                        <i class="fas fa-plus"></i> Add Meal
                    </button>
                    <button class="btn btn-secondary" onclick="generateGroceryList()">
                        <i class="fas fa-shopping-cart"></i> Grocery List
                    </button>
                    <button class="btn btn-secondary" onclick="printMealPlan()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </div>

            <!-- Week Navigation -->
            <div class="week-nav">
                <a href="?week_start={{ prev_week.strftime('%Y-%m-%d') }}" class="nav-btn">
                    <i class="fas fa-chevron-left"></i> Previous Week
                </a>
                <div class="week-display">
                    <div>Week of {{ week_start.strftime('%B %d, %Y') }}</div>
                    <small>
                        {% set week_end = week_start + timedelta(days=6) %}
                        {{ week_start.strftime('%b %d') }} - {{ week_end.strftime('%b %d, %Y') }}
                    </small>
                </div>
                <a href="?week_start={{ next_week.strftime('%Y-%m-%d') }}" class="nav-btn">
                    Next Week <i class="fas fa-chevron-right"></i>
                </a>
            </div>
        </div>

        <!-- Debug Test Button -->
        <div style="margin-bottom: 20px; text-align: center;">
            <button type="button" class="btn btn-primary" onclick="testModal()" style="margin: 10px;">
                üß™ Test Modal
            </button>
        </div>
        
        <!-- Meal Grid -->
        <div class="meal-grid-container">
            <div class="meal-grid">
                <!-- Empty corner cell -->
                <div class="grid-header meal-type-header"></div>
                
                <!-- Day headers -->
                {% for day in days %}
                <div class="grid-header day-header">
                    {{ day.day_short }}<br>
                    <small>{{ day.date.strftime('%m/%d') }}</small>
                </div>
                {% endfor %}

                <!-- Meal rows -->
                {% for meal_type in meal_types %}
                <div class="grid-header meal-type-header">
                    {% if meal_type == 'breakfast' %}üåÖ{% elif meal_type == 'lunch' %}üåû{% elif meal_type == 'dinner' %}üåô{% else %}üçé{% endif %}
                    {{ meal_type|title }}
                </div>
                
                {% for day in days %}
                <div class="meal-slot" data-day="{{ day.day_number }}" data-meal-type="{{ meal_type }}">
                    {% set meal = day.meals[meal_type] %}
                    {% if meal %}
                    <div class="meal-item">
                        <div class="meal-actions">
                            <button class="action-btn edit-btn" onclick="editMeal({{ day.day_number }}, '{{ meal_type }}', {{ meal.recipe_id }}, '{{ meal.recipe_title }}', '{{ meal.recipe_image }}', {{ meal.servings }}, '{{ meal.notes }}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" onclick="removeMeal({{ day.day_number }}, '{{ meal_type }}')" title="Remove">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        
                        {% if meal.recipe_image %}
                        <img src="{{ meal.recipe_image }}" alt="{{ meal.recipe_title }}" class="meal-image">
                        {% endif %}
                        
                        <div class="meal-title">{{ meal.recipe_title }}</div>
                        <div class="meal-meta">
                            <i class="fas fa-users"></i> {{ meal.servings }} serving{% if meal.servings != 1 %}s{% endif %}
                        </div>
                        {% if meal.notes %}
                        <div class="meal-notes">{{ meal.notes }}</div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="meal-slot empty" onclick="openAddMealModal({{ day.day_number }}, '{{ meal_type }}')">
                        <i class="fas fa-plus"></i>
                        <small>Add {{ meal_type }}</small>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Meal Modal -->
<div class="modal-overlay" id="mealModal">
    <div class="modal">
        <div class="modal-header">
            <h3><i class="fas fa-plus"></i> <span id="modalTitle">Add Meal to Plan</span></h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="mealForm">
                <input type="hidden" id="selectedDay" value="">
                <input type="hidden" id="selectedMealType" value="">
                <input type="hidden" id="isEditMode" value="false">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="mealDay">Day <span class="help-tooltip" data-tooltip="Select which day to add the meal"><i class="fas fa-question-circle"></i></span></label>
                        <select class="form-control" id="mealDay" required>
                            <option value="">Select day...</option>
                            {% for day in days %}
                            <option value="{{ day.day_number }}">{{ day.day_short }} - {{ day.date.strftime('%m/%d') }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mealType">Meal Type</label>
                        <select class="form-control" id="mealType" required>
                            <option value="">Select meal type...</option>
                            {% for meal_type in meal_types %}
                            <option value="{{ meal_type }}">
                                {% if meal_type == 'breakfast' %}üåÖ{% elif meal_type == 'lunch' %}üåû{% elif meal_type == 'dinner' %}üåô{% else %}üçé{% endif %}
                                {{ meal_type|title }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="search-section">
                    <div class="form-group">
                        <label for="recipeSearch">Search for a Recipe</label>
                        <div class="search-box">
                            <input type="text" class="form-control search-input" id="recipeSearch" 
                                   placeholder="Try 'chicken pasta' or 'healthy salad'..." autocomplete="off">
                            <button type="button" class="search-btn" onclick="searchRecipes()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <div id="recipeResults" class="recipe-results" style="display: none;"></div>
                </div>

                <div id="selectedRecipeInfo" class="selected-recipe" style="display: none;">
                    <h4>Selected Recipe</h4>
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                        <img id="selectedRecipeImage" src="" alt="" style="width: 100px; height: 100px; object-fit: cover; border-radius: 10px;">
                        <div>
                            <h5 id="selectedRecipeTitle"></h5>
                            <p id="selectedRecipeMeta" style="color: #666; margin: 0;"></p>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="servings">Servings <span class="help-tooltip" data-tooltip="How many people will this serve?"><i class="fas fa-question-circle"></i></span></label>
                            <input type="number" class="form-control" id="servings" value="2" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label for="notes">Notes (Optional)</label>
                            <input type="text" class="form-control" id="notes" placeholder="Add cooking notes or modifications...">
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveMeal()">
                        <i class="fas fa-save"></i> Save Meal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>
{% endblock %}

{% block extra_js %}
<script>
let selectedRecipe = null;
let searchTimeout = null;

// Open add meal modal
function openAddMealModal(day = null, mealType = null) {
    console.log('Opening modal for day:', day, 'meal type:', mealType);
    
    if (day !== null && mealType !== null) {
        document.getElementById('mealDay').value = day;
        document.getElementById('mealType').value = mealType;
        document.getElementById('selectedDay').value = day;
        document.getElementById('selectedMealType').value = mealType;
    }
    document.getElementById('isEditMode').value = 'false';
    document.getElementById('modalTitle').textContent = 'Add Meal to Plan';
    document.getElementById('mealForm').reset();
    document.getElementById('selectedRecipeInfo').style.display = 'none';
    document.getElementById('recipeResults').style.display = 'none';
    selectedRecipe = null;
    
    const modal = document.getElementById('mealModal');
    console.log('Modal element:', modal);
    console.log('Modal classes before:', modal.className);
    modal.classList.add('active');
    console.log('Modal classes after:', modal.className);
    console.log('Modal computed styles:', window.getComputedStyle(modal));
    
    // Force modal to be visible
    modal.style.display = 'flex';
    modal.style.opacity = '1';
    modal.style.visibility = 'visible';
    
    // Force modal content to be visible
    const modalContent = modal.querySelector('.modal');
    if (modalContent) {
        modalContent.style.display = 'block';
        modalContent.style.transform = 'scale(1)';
        modalContent.style.opacity = '1';
        modalContent.style.visibility = 'visible';
        console.log('Modal content forced visible');
    }
}

// Edit meal
function editMeal(day, mealType, recipeId, recipeTitle, recipeImage, servings, notes) {
    document.getElementById('mealDay').value = day;
    document.getElementById('mealType').value = mealType;
    document.getElementById('selectedDay').value = day;
    document.getElementById('selectedMealType').value = mealType;
    document.getElementById('isEditMode').value = 'true';
    document.getElementById('modalTitle').textContent = 'Edit Meal';
    
    selectedRecipe = {
        id: recipeId,
        title: recipeTitle,
        image: recipeImage
    };
    
    document.getElementById('selectedRecipeImage').src = recipeImage;
    document.getElementById('selectedRecipeTitle').textContent = recipeTitle;
    document.getElementById('servings').value = servings;
    document.getElementById('notes').value = notes;
    document.getElementById('selectedRecipeInfo').style.display = 'block';
    
    document.getElementById('mealModal').classList.add('active');
}

// Test modal function
function testModal() {
    console.log('Testing modal...');
    const modal = document.getElementById('mealModal');
    console.log('Modal element:', modal);
    console.log('Modal exists:', !!modal);
    if (modal) {
        console.log('Modal classes:', modal.className);
        console.log('Modal style:', modal.style.cssText);
        console.log('Modal computed style:', window.getComputedStyle(modal));
        modal.classList.add('active');
        console.log('Modal classes after adding active:', modal.className);
    } else {
        alert('Modal element not found!');
    }
}

// Close modal
function closeModal() {
    document.getElementById('mealModal').classList.remove('active');
}

// Search recipes
function searchRecipes() {
    const query = document.getElementById('recipeSearch').value.trim();
    if (!query) {
        showToast('Please enter a search term', 'error');
        return;
    }
    
    const resultsContainer = document.getElementById('recipeResults');
    resultsContainer.innerHTML = '<div class="text-center p-3"><div class="spinner"></div> Searching...</div>';
    resultsContainer.style.display = 'block';
    
    fetch('/search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `query=${encodeURIComponent(query)}&max_results=10`
    })
    .then(response => response.json())
    .then(data => {
        if (data.recipes && data.recipes.length > 0) {
            displayRecipeResults(data.recipes);
        } else {
            resultsContainer.innerHTML = '<div class="text-center p-3 text-muted">No recipes found</div>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        resultsContainer.innerHTML = '<div class="text-center p-3 text-danger">Error searching recipes</div>';
    });
}

// Display recipe search results
function displayRecipeResults(recipes) {
    const resultsContainer = document.getElementById('recipeResults');
    resultsContainer.innerHTML = '';
    
    recipes.forEach(recipe => {
        const recipeItem = document.createElement('div');
        recipeItem.className = 'recipe-item';
        recipeItem.innerHTML = `
            <img src="${recipe.image}" alt="${recipe.title}" class="recipe-image">
            <div class="recipe-info">
                <div class="recipe-title">${recipe.title}</div>
                <div class="recipe-meta">
                    <i class="fas fa-clock"></i> ${recipe.readyInMinutes} min | 
                    <i class="fas fa-star"></i> ${recipe.rating || 'N/A'}
                </div>
            </div>
            <button class="select-recipe-btn" onclick="selectRecipe(${recipe.id}, '${recipe.title}', '${recipe.image}')">
                Select
            </button>
        `;
        resultsContainer.appendChild(recipeItem);
    });
}

// Select a recipe
function selectRecipe(recipeId, recipeTitle, recipeImage) {
    selectedRecipe = {
        id: recipeId,
        title: recipeTitle,
        image: recipeImage
    };
    
    document.getElementById('selectedRecipeImage').src = recipeImage;
    document.getElementById('selectedRecipeTitle').textContent = recipeTitle;
    document.getElementById('selectedRecipeInfo').style.display = 'block';
    document.getElementById('recipeResults').style.display = 'none';
}

// Save meal to plan
function saveMeal() {
    const day = document.getElementById('mealDay').value;
    const mealType = document.getElementById('mealType').value;
    const servings = document.getElementById('servings').value;
    const notes = document.getElementById('notes').value;
    const isEditMode = document.getElementById('isEditMode').value === 'true';
    
    if (!day || !mealType) {
        showToast('Please select day and meal type', 'error');
        return;
    }
    
    if (!selectedRecipe) {
        showToast('Please select a recipe', 'error');
        return;
    }
    
    const mealData = {
        week_start: '{{ week_start.strftime("%Y-%m-%d") }}',
        day_of_week: parseInt(day),
        meal_type: mealType,
        recipe_id: selectedRecipe.id,
        recipe_title: selectedRecipe.title,
        recipe_image: selectedRecipe.image,
        servings: parseInt(servings),
        notes: notes
    };
    
    fetch('/meal-plan/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(mealData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'added') {
            showToast('Meal added successfully!', 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast('Error adding meal', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error adding meal', 'error');
    });
}

// Remove meal from plan
function removeMeal(day, mealType) {
    if (!confirm('Are you sure you want to remove this meal?')) {
        return;
    }
    
    const mealData = {
        week_start: '{{ week_start.strftime("%Y-%m-%d") }}',
        day_of_week: day,
        meal_type: mealType
    };
    
    fetch('/meal-plan/remove', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(mealData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'removed') {
            showToast('Meal removed successfully!', 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast('Error removing meal', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error removing meal', 'error');
    });
}

// Generate grocery list
function generateGroceryList() {
    showToast('Grocery list feature coming soon!', 'info');
}

// Print meal plan
function printMealPlan() {
    window.print();
}

// Show toast notification
function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            ${message}
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Auto-search on input
document.getElementById('recipeSearch').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim();
    
    if (query.length >= 3) {
        searchTimeout = setTimeout(() => {
            searchRecipes();
        }, 500);
    }
});

// Close modal when clicking outside
document.getElementById('mealModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    // Initialize any Bootstrap components
    if (typeof bootstrap !== 'undefined') {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
});
</script>
{% endblock %} 